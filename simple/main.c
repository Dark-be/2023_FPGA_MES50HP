#include <stdint.h>

#include "../include/utils.h"
#include "../include/uart.h"
#include "../include/xprintf.h"
#include "../include/gpio.h"
#include "../include/spi.h"

#define DELAY_US(a) busy_wait(a)
#define DELAY_MS(a) busy_wait(a * 1000)

#define PLAY(a) BUZZ_UP();busy_wait(1000000/a);BUZZ_DOWN();busy_wait(1000000/a);

//global param
#define GAME_COUNT 3
#define GAME_RANDOM (uint8_t)frame_time*113
#define COMMAND_A 'A'
#define COMMAND_W 'W'
#define COMMAND_S 'S'
#define COMMAND_D 'D'
#define COMMAND_Q 'Q'

#define ROCK_UP() GPIO_HIGH(12)
#define ROCK_DOWN() GPIO_LOW(12)

#define BUZZ_UP() GPIO_HIGH(13)
#define BUZZ_DOWN() GPIO_LOW(13)

//game param
#define SNAKE_MAP_HEIGHT 12
#define SNAKE_MAP_WIDTH 16
#define SNAKE_DELAY 16//800/50

#define TETRIS_MAP_HEIGHT 12
#define TETRIS_MAP_WIDTH 16
#define TETRIS_DELAY 8//1000/50


#pragma region GPIO
#define GPIO_INPUT(a) GPIO_REG(GPIO_CTRL) |= ((uint32_t)0x1 << (a*2+1))
#define GPIO_OUTPUT(a) GPIO_REG(GPIO_CTRL) |= ((uint32_t)0x1 << (a*2))
#define GPIO_STATE(a) (GPIO_REG(GPIO_DATA) & ((uint32_t)0x1 << a))
#define GPIO_HIGH(a) GPIO_REG(GPIO_DATA) |= ((uint32_t)0x1 << a)
#define GPIO_LOW(a) GPIO_REG(GPIO_DATA) &= ~((uint32_t)0x1 << a)
#define GPIO_TOGGLE(a) GPIO_REG(GPIO_DATA) ^= ((uint32_t)0x1 << a)

void gpio_init(){
    GPIO_OUTPUT(0);//LCD
    GPIO_OUTPUT(1);//LCD
    GPIO_OUTPUT(2);//RGB

    GPIO_INPUT(3);//KEY
    GPIO_INPUT(4);
    GPIO_INPUT(5);
    GPIO_INPUT(6);
    GPIO_INPUT(7);

    GPIO_OUTPUT(8);//LED
    GPIO_OUTPUT(9);
    GPIO_OUTPUT(10);
    GPIO_OUTPUT(11);

    GPIO_OUTPUT(12);//
    GPIO_OUTPUT(13);
    GPIO_OUTPUT(14);
    GPIO_OUTPUT(15);


    GPIO_LOW(2);//led
    GPIO_HIGH(13);
    GPIO_HIGH(8);
    GPIO_LOW(9);
    GPIO_HIGH(10);
    GPIO_LOW(11);

}
#pragma endregion
// gpio 0 1 已被用作dc rst
#pragma region LCD
//color
#define COLOR_RED 0xF800
#define COLOR_ORANGE 0xFC00
#define COLOR_YELLOW 0xFFE0
#define COLOR_GREEN 0x07E0
#define COLOR_GRASS 0x87E0
#define COLOR_CYAN 0x07FF
#define COLOR_BLUE 0x001F
#define COLOR_PUPPLE 0xF81F
#define COLOR_BLACK 0x0000
#define COLOR_WHITE 0xFFFF
#define COLOR_GRAY 0x8410
#define LCD_WIDTH   240
#define LCD_HEIGHT  320

#define LCD_DC_HIGH()   GPIO_REG(GPIO_DATA) |= 0x1;  // 1 DC data
#define LCD_DC_LOW()    GPIO_REG(GPIO_DATA) &= ~0x1; // 0 DC command

#define LCD_RST_HIGH()  GPIO_REG(GPIO_DATA) |= 0x2;  // 1 RST
#define LCD_RST_LOW()   GPIO_REG(GPIO_DATA) &= ~0x2; // 0 RST

void lcd_write(uint8_t data){//SPI_MODE0 common low up sample
    spi_write_byte(data);
}

void lcd_reset(){
    LCD_RST_LOW();
    DELAY_MS(100);
    LCD_RST_HIGH();
    DELAY_MS(100);
}
// Command
void lcd_write_command(uint8_t command){
    LCD_DC_LOW();
    lcd_write(command);
}
// Data
void lcd_write_data(uint8_t data){
    LCD_DC_HIGH();
    lcd_write(data);
}
// Configure
void lcd_configure()
{
    //功耗控制B
    DELAY_MS(1);
    lcd_write_command(0xCF);
	lcd_write_data(0x00);
	lcd_write_data(0xC1);
	lcd_write_data(0X30);
    //电源时序控制
    DELAY_MS(1);
	lcd_write_command(0xED);
	lcd_write_data(0x64);
	lcd_write_data(0x03);
	lcd_write_data(0X12);
	lcd_write_data(0X81);
    //驱动时序控制A
    DELAY_MS(1);
	lcd_write_command(0xE8); 
	lcd_write_data(0x85);
	lcd_write_data(0x10);
	lcd_write_data(0x7A);
    //功耗控制A
    DELAY_MS(1);
	lcd_write_command(0xCB);
	lcd_write_data(0x39);
	lcd_write_data(0x2C);
	lcd_write_data(0x00);
	lcd_write_data(0x34);
	lcd_write_data(0x02);
    //泵比控制
    DELAY_MS(1);
	lcd_write_command(0xF7);
	lcd_write_data(0x20);
    //驱动时序控制B
    DELAY_MS(1);
	lcd_write_command(0xEA);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
    //功耗控制1
    DELAY_MS(1);
	lcd_write_command(0xC0);  //Power control 
	lcd_write_data(0x1B);  //VRH[5:0]
    //功耗控制2
    DELAY_MS(1);
	lcd_write_command(0xC1);  //Power control 
	lcd_write_data(0x01);  //SAP[2:0];BT[3:0]
    //VCOM控制1
    DELAY_MS(1);
	lcd_write_command(0xC5);
	lcd_write_data(0x30);
	lcd_write_data(0x30);
    //VCOM控制2
    DELAY_MS(1);
	lcd_write_command(0xC7);
	lcd_write_data(0XB7);
    //存储器访问控制
    DELAY_MS(1);
	lcd_write_command(0x36);
	lcd_write_data(0x48);
    //像素格式设置
    DELAY_MS(1);
	lcd_write_command(0x3A);
	lcd_write_data(0x55);
    //帧速率控制（正常模式/全色模式）
    DELAY_MS(1);
	lcd_write_command(0xB1);
	lcd_write_data(0x00);
	lcd_write_data(0x1A);
    //显示功能设置控制
    DELAY_MS(1);
	lcd_write_command(0xB6);
	lcd_write_data(0x0A);
	lcd_write_data(0xA2);
    //使能3G
    DELAY_MS(1);
	lcd_write_command(0xF2);  
	lcd_write_data(0x00);  //3Gamma Function Disable 
    //伽马设置
    DELAY_MS(1);
	lcd_write_command(0x26);  
	lcd_write_data(0x01);  //Gamma curve selected 
    //正极伽马校正
    DELAY_MS(1);
	lcd_write_command(0xE0);
	lcd_write_data(0x0F);
	lcd_write_data(0x2A);
	lcd_write_data(0x28);
	lcd_write_data(0x08);
	lcd_write_data(0x0E);
	lcd_write_data(0x08);
	lcd_write_data(0x54);
	lcd_write_data(0XA9);
	lcd_write_data(0x43);
	lcd_write_data(0x0A);
	lcd_write_data(0x0F);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
    //负极伽马校正
    DELAY_MS(1);
	lcd_write_command(0XE1);
	lcd_write_data(0x00);
	lcd_write_data(0x15);
	lcd_write_data(0x17);
	lcd_write_data(0x07);
	lcd_write_data(0x11);
	lcd_write_data(0x06);
	lcd_write_data(0x2B);
	lcd_write_data(0x56);
	lcd_write_data(0x3C);
	lcd_write_data(0x05);
	lcd_write_data(0x10);
	lcd_write_data(0x0F);
	lcd_write_data(0x3F);
	lcd_write_data(0x3F);
	lcd_write_data(0x0F);
    //行地址设置
    DELAY_MS(1);
	lcd_write_command(0x2B);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
	lcd_write_data(0x01);
	lcd_write_data(0x3f);
    //列地址设置
    DELAY_MS(1);
	lcd_write_command(0x2A);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
	lcd_write_data(0x00);
	lcd_write_data(0xef);
    //退出睡眠模式
    DELAY_MS(1);
	lcd_write_command(0x11);
    //开显示(0x28为关显示)
    DELAY_MS(300);
	lcd_write_command(0x29);
}

void lcd_set_windows(uint16_t x_start, uint16_t y_start, uint16_t x_end, uint16_t y_end){
    lcd_write_command(0x2a);
    lcd_write_data(x_start >> 8);
    lcd_write_data(x_start & 0xff);
    lcd_write_data(x_end >> 8);
    lcd_write_data(x_end & 0xff);

    lcd_write_command(0x2b);
    lcd_write_data(y_start >> 8);
    lcd_write_data(y_start & 0xff);
    lcd_write_data(y_end >> 8);
    lcd_write_data(y_end & 0xff);

    lcd_write_command(0x2c);
}

void lcd_set_cursor(uint16_t x, uint16_t y){
    lcd_write_command(0x2a);
    lcd_write_data(x >> 8);
    lcd_write_data(x & 0xff);
    lcd_write_command(0x2b);
    lcd_write_data(y >> 8);
    lcd_write_data(y & 0xff);
    lcd_write_command(0x2c);
}

void lcd_write_gram(uint16_t data){
    lcd_write_data(data >> 8);
    lcd_write_data(data & 0xff);
}

void lcd_init(){
    lcd_reset();
    lcd_configure();
}

void lcd_clear(uint16_t color){
    lcd_set_windows(0, 0, LCD_WIDTH - 1, LCD_HEIGHT - 1);
    for(int i=0;i<LCD_WIDTH;i++){
        for(int j=0;j<LCD_HEIGHT;j++){
            lcd_write_gram(color);
        }
    }
}

void lcd_draw_point(uint16_t x, uint16_t y, uint16_t color){
    uint8_t tmp = y;
    y=LCD_HEIGHT-x-1;
    x=tmp;
    lcd_set_cursor(x, y);
    lcd_write_gram(color);
}

void lcd_draw_rect(uint16_t x, uint16_t y, uint16_t width, uint16_t height, uint16_t color){
    //trans
    //               y       y
    //                  x =>    x
    uint8_t tmp = y;
    y=LCD_HEIGHT-x-width;
    x=tmp;
    lcd_set_windows(x, y, x + height - 1, y + width - 1);
    for(int i=0;i<width;i++){
        for(int j=0;j<height;j++){
            lcd_write_gram(color);
        }
    }
}
//MENU PRESSUP SNAKE TETRIS BIRDS
const uint8_t font[][16] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x07,0x00,0x00,0xF0,0x07,0x00,0x00,0xFE,0x07},
{0x00,0xE0,0xFF,0x07,0x00,0xFC,0x7F,0x00,0xC0,0xFF,0x1F,0x00,0xC0,0xFF,0x1C,0x00},
{0xC0,0x1F,0x1C,0x00,0xC0,0xFF,0x1C,0x00,0x80,0xFF,0x1F,0x00,0x00,0xF8,0xFF,0x00},
{0x00,0xC0,0xFF,0x07,0x00,0x00,0xFE,0x07,0x00,0x00,0xE0,0x07,0x00,0x00,0x00,0x07},/*"A",0*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06},
{0xC0,0x80,0x01,0x06,0xC0,0x81,0x03,0x06,0xC0,0xC1,0x03,0x07,0xC0,0xFF,0x87,0x07},
{0x80,0xFF,0xFF,0x07,0x00,0x7F,0xFE,0x03,0x00,0x3E,0xFC,0x01,0x00,0x00,0x78,0x00},/*"B",1*/
// {0x00,0x00,0x00,0x00,0x00,0xE0,0x1F,0x00,0x00,0xFC,0xFF,0x00,0x00,0xFF,0xFF,0x01},
// {0x80,0xFF,0xFF,0x03,0xC0,0x1F,0xE0,0x07,0xC0,0x03,0x00,0x07,0xC0,0x01,0x00,0x0E},
// {0xC0,0x00,0x00,0x0E,0xC0,0x00,0x00,0x0E,0xC0,0x01,0x00,0x0F,0xC0,0x03,0x80,0x07},
// {0x80,0x3F,0xF8,0x07,0x80,0x3F,0xF8,0x03,0x00,0x3F,0xF8,0x01,0x00,0x38,0x38,0x00},/*"C",2*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0x00,0x00,0x06,0xC0,0x00,0x00,0x06,0xC0,0x01,0x00,0x06},
{0xC0,0x01,0x00,0x07,0xC0,0x03,0x00,0x07,0x80,0x07,0x80,0x07,0x80,0x3F,0xF8,0x03},
{0x00,0xFF,0xFF,0x03,0x00,0xFE,0xFF,0x01,0x00,0xFC,0x7F,0x00,0x00,0xC0,0x07,0x00},/*"D",3*/

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06},
{0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06},
{0xC0,0x80,0x01,0x06,0xC0,0x80,0x01,0x06,0xC0,0x00,0x00,0x06,0x00,0x00,0x00,0x06},/*"E",4*/

// {0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0x80,0x03,0x00,0xC0,0x80,0x03,0x00,0xC0,0x80,0x03,0x00},
// {0xC0,0x80,0x03,0x00,0xC0,0x80,0x03,0x00,0xC0,0x80,0x03,0x00,0xC0,0x80,0x03,0x00},
// {0xC0,0x80,0x03,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00},/*"F",5*/

{0x00,0x00,0x00,0x00,0x00,0xE0,0x1F,0x00,0x00,0xFC,0xFF,0x00,0x00,0xFF,0xFF,0x03},
{0x80,0xFF,0xFF,0x03,0xC0,0x0F,0xE0,0x07,0xC0,0x03,0x00,0x07,0xC0,0x01,0x00,0x0E},
{0xC0,0x00,0x06,0x0E,0xC0,0x00,0x06,0x0E,0xC0,0x01,0x06,0x07,0xC0,0x1F,0x86,0x07},
{0x80,0x1F,0xFE,0x0F,0x00,0x1F,0xFE,0x0F,0x00,0x1E,0xFE,0x0F,0x00,0x00,0x00,0x00},/*"G",6*/

// {0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00},
// {0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00,0x00,0x80,0x01,0x00,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00},/*"H",7*/

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"I",8*/

// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x01,0x00,0x00,0xF8,0x03},
// {0x00,0x00,0xF8,0x07,0x00,0x00,0xF8,0x07,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x0E},
// {0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x03,0xC0,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00},/*"J",9*/
{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0x00,0xC0,0x07,0x00,0x00,0xF0,0x03,0x00,0x00,0xF8,0x07,0x00},
{0x00,0xFC,0x1F,0x00,0x00,0xBF,0x7F,0x00,0x80,0x1F,0xFE,0x01,0xC0,0x07,0xF8,0x03},
{0xC0,0x03,0xE0,0x07,0xC0,0x01,0xC0,0x07,0xC0,0x00,0x00,0x07,0x00,0x00,0x00,0x04},/*"K",10*/
// {0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06},
// {0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06},
// {0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x06},/*"L",11*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0x0F,0x00,0x00,0xFE,0xFF,0x01,0x00,0xC0,0xFF,0x07},
{0x00,0x00,0xFC,0x07,0x00,0xF0,0xFF,0x07,0x80,0xFF,0xFF,0x00,0xC0,0xFF,0x07,0x00},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},/*"M",12*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0x7F,0x00,0x00,0x00,0xFE,0x01,0x00,0x00,0xF8,0x07,0x00},
{0x00,0xE0,0x1F,0x00,0x00,0x80,0xFF,0x00,0x00,0x00,0xFC,0x03,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00},/*"N",13*/

{0x00,0x00,0x00,0x00,0x00,0xF8,0x3F,0x00,0x00,0xFE,0xFF,0x01,0x80,0xFF,0xFF,0x03},
{0x80,0xFF,0xFF,0x07,0xC0,0x07,0xC0,0x07,0xC0,0x01,0x00,0x07,0xC0,0x00,0x00,0x0E},
{0xC0,0x00,0x00,0x0E,0xC0,0x01,0x00,0x0E,0xC0,0x03,0x00,0x07,0xC0,0x0F,0xE0,0x07},
{0x80,0xFF,0xFF,0x07,0x00,0xFF,0xFF,0x03,0x00,0xFE,0xFF,0x00,0x00,0xE0,0x1F,0x00},/*"O",14*/

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0x00,0x06,0x00,0xC0,0x00,0x06,0x00},
{0xC0,0x00,0x06,0x00,0xC0,0x01,0x07,0x00,0xC0,0x01,0x07,0x00,0xC0,0x83,0x07,0x00},
{0x80,0xFF,0x03,0x00,0x80,0xFF,0x03,0x00,0x00,0xFF,0x01,0x00,0x00,0x7C,0x00,0x00},/*"P",15*/

{0x00,0x00,0x00,0x00,0x00,0xF8,0x3F,0x00,0x00,0xFE,0xFF,0x01,0x80,0xFF,0xFF,0x03},
{0x80,0xFF,0xFF,0x07,0xC0,0x07,0xC0,0x07,0xC0,0x01,0x00,0x07,0xC0,0x00,0x00,0x0E},
{0xC0,0x00,0x30,0x0E,0xC0,0x01,0xF8,0x0E,0xC0,0x03,0xF8,0x07,0xC0,0x0F,0xE0,0x0F},
{0x80,0xFF,0xFF,0x0F,0x00,0xFF,0xFF,0x0F,0x00,0xFE,0xFF,0x04,0x00,0xE0,0x1F,0x00},/*"Q",16*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00,0xC0,0x00,0x03,0x00},
{0xC0,0x00,0x0F,0x00,0xC0,0x81,0x3F,0x00,0xC0,0x81,0xFF,0x00,0xC0,0xFF,0xFF,0x03},
{0x80,0xFF,0xF1,0x07,0x80,0xFF,0xC1,0x07,0x00,0xFE,0x00,0x07,0x00,0x00,0x00,0x04},/*"R",17*/

{0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x3F,0xE0,0x01,0x80,0x7F,0xE0,0x03},
{0x80,0xFF,0xE0,0x07,0xC0,0xFF,0x81,0x07,0xC0,0xE1,0x01,0x0E,0xC0,0xC0,0x01,0x0E},
{0xC0,0x80,0x03,0x0E,0xC0,0x81,0x07,0x0E,0xC0,0x83,0x07,0x07,0xC0,0x0F,0x9F,0x07},
{0x80,0x0F,0xFE,0x07,0x00,0x0F,0xFE,0x03,0x00,0x0C,0xFC,0x01,0x00,0x00,0x00,0x00},/*"S",18*/

{0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00},
{0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00},
{0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"T",19*/

{0x00,0x00,0x00,0x00,0xC0,0xFF,0x7F,0x00,0xC0,0xFF,0xFF,0x01,0xC0,0xFF,0xFF,0x03},
{0xC0,0xFF,0xFF,0x07,0x00,0x00,0x80,0x07,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x0E},
{0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0F,0xC0,0xFF,0xFF,0x07},
{0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x03,0xC0,0xFF,0xFF,0x01,0x00,0x00,0x00,0x00},/*"U",20*/

{0x40,0x00,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x3F,0x00,0x00,0xC0,0xFF,0x01,0x00},
{0x80,0xFF,0x1F,0x00,0x00,0xF8,0xFF,0x00,0x00,0xC0,0xFF,0x0F,0x00,0x00,0xFC,0x0F},
{0x00,0x00,0xF0,0x0F,0x00,0x00,0xFF,0x0F,0x00,0xE0,0xFF,0x03,0x00,0xFE,0x3F,0x00},
{0xC0,0xFF,0x07,0x00,0xC0,0xFF,0x00,0x00,0xC0,0x0F,0x00,0x00,0xC0,0x01,0x00,0x00},/*"V",21*/
// {0xC0,0x01,0x00,0x00,0xC0,0xFF,0x01,0x00,0xC0,0xFF,0xFF,0x01,0xC0,0xFF,0xFF,0x0F},
// {0x00,0xF0,0xFF,0x0F,0x00,0xF0,0xFF,0x0F,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0x0F,0x00},
// {0xC0,0xFF,0x00,0x00,0xC0,0xFF,0x7F,0x00,0x00,0xFE,0xFF,0x0F,0x00,0x00,0xFF,0x0F},
// {0x80,0xFF,0xFF,0x0F,0xC0,0xFF,0xFF,0x0F,0xC0,0xFF,0x1F,0x00,0xC0,0x1F,0x00,0x00},/*"W",22*/
// {0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x06,0xC0,0x01,0x00,0x07,0xC0,0x07,0xC0,0x07},
// {0xC0,0x1F,0xF0,0x07,0x80,0x3F,0xFC,0x01,0x00,0xFE,0x7F,0x00,0x00,0xF8,0x1F,0x00},
// {0x00,0xF0,0x0F,0x00,0x00,0xFC,0x3F,0x00,0x00,0x7F,0xFE,0x00,0xC0,0x1F,0xF8,0x03},
// {0xC0,0x0F,0xE0,0x07,0xC0,0x03,0x80,0x07,0xC0,0x00,0x00,0x06,0x00,0x00,0x00,0x04},/*"X",23*/
// {0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x03,0x00,0x00,0xC0,0x0F,0x00,0x00},
// {0xC0,0x3F,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFC,0xFF,0x07,0x00,0xE0,0xFF,0x07},
// {0x00,0xC0,0xFF,0x07,0x00,0xF0,0xFF,0x07,0x00,0xFC,0x01,0x00,0x00,0x7F,0x00,0x00},
// {0xC0,0x1F,0x00,0x00,0xC0,0x07,0x00,0x00,0xC0,0x01,0x00,0x00,0x40,0x00,0x00,0x00},/*"Y",24*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x00,0x80,0x07,0xC0,0x00,0xE0,0x07},
// {0xC0,0x00,0xF8,0x07,0xC0,0x00,0xFC,0x06,0xC0,0x00,0x7F,0x06,0xC0,0x80,0x1F,0x06},
// {0xC0,0xE0,0x07,0x06,0xC0,0xF8,0x03,0x06,0xC0,0xFC,0x00,0x06,0xC0,0x3F,0x00,0x06},
// {0xC0,0x1F,0x00,0x06,0xC0,0x07,0x00,0x06,0xC0,0x01,0x00,0x06,0x00,0x00,0x00,0x06},/*"Z",25*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x01,0x00,0x00,0xE3,0x03,0x00,0x80,0xF3,0x07},
// {0x00,0xC0,0xF3,0x07,0x00,0xE0,0x3B,0x0E,0x00,0xE0,0x18,0x0E,0x00,0xE0,0x18,0x0E},
// {0x00,0x60,0x18,0x06,0x00,0xE0,0x18,0x07,0x00,0xE0,0x9C,0x07,0x00,0xC0,0xFF,0x07},
// {0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x07,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00},/*"a",0*/
// {0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0x00,0xC0,0x83,0x07,0x00,0xE0,0x00,0x06,0x00,0x60,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x01,0x07,0x00,0xE0,0xFF,0x07},
// {0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x03,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00},/*"b",1*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFF,0x01,0x00,0x80,0xFF,0x03},
// {0x00,0xC0,0xFF,0x07,0x00,0xC0,0x81,0x07,0x00,0xE0,0x00,0x06,0x00,0xE0,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x00,0x07,0x00,0xC0,0xC3,0x07},
// {0x00,0xC0,0xC3,0x07,0x00,0x80,0xC3,0x03,0x00,0x00,0xC3,0x01,0x00,0x00,0x00,0x00},/*"c",2*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x80,0xFF,0x01,0x00,0xC0,0xFF,0x03},
// {0x00,0xC0,0xFF,0x07,0x00,0xE0,0x01,0x07,0x00,0xE0,0x00,0x0E,0x00,0x60,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x06,0x00,0xC0,0x01,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00},/*"d",3*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFF,0x01,0x00,0x80,0xFF,0x03},
// {0x00,0xC0,0xFF,0x07,0x00,0xC0,0x8D,0x07,0x00,0xE0,0x0C,0x06,0x00,0x60,0x0C,0x0E},
// {0x00,0x60,0x0C,0x0E,0x00,0xE0,0x0C,0x0E,0x00,0xE0,0x0C,0x0E,0x00,0xC0,0x8F,0x07},
// {0x00,0xC0,0x8F,0x07,0x00,0x80,0x8F,0x03,0x00,0x00,0x8F,0x01,0x00,0x00,0x00,0x00},/*"e",4*/
// {0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00},
// {0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0xFF,0xFF,0x07,0x80,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0x61,0x00,0x00,0xC0,0x60,0x00,0x00,0xC0,0x60,0x00,0x00},
// {0xC0,0x60,0x00,0x00,0xC0,0x61,0x00,0x00,0xC0,0x01,0x00,0x00,0x00,0x00,0x00,0x00},/*"f",5*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0xC6,0x79,0x00,0x80,0xDF,0x7F},
// {0x00,0xC0,0xFF,0xFF,0x00,0xE0,0x7F,0xC7,0x00,0xE0,0x70,0xC7,0x00,0x60,0x60,0xC6},
// {0x00,0x60,0x60,0xC6,0x00,0xE0,0x70,0xC6,0x00,0xC0,0x3F,0xC6,0x00,0xC0,0x3F,0xE6},
// {0x00,0xE0,0x1F,0x7E,0x00,0x60,0x00,0x7E,0x00,0x60,0x00,0x3C,0x00,0x60,0x00,0x00},/*"g",6*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0x00,0x80,0x07,0x00,0x00,0xC0,0x01,0x00,0x00,0xE0,0x00,0x00},
// {0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x07,0x00,0x00,0x00,0x00},/*"h",7*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE1,0xFF,0x07,0xC0,0xE1,0xFF,0x07},
// {0xC0,0xE1,0xFF,0x07,0xC0,0xE1,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"i",8*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0},
// {0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xC0},
// {0x00,0x00,0x00,0xE0,0xC0,0xE1,0xFF,0xFF,0xC0,0xE1,0xFF,0x7F,0xC0,0xE1,0xFF,0x3F},
// {0xC0,0xE1,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"j",9*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0x00,0x00,0x3C,0x00,0x00,0x00,0x1E,0x00,0x00,0x00,0x0F,0x00},
// {0x00,0x80,0x3F,0x00,0x00,0xC0,0xFF,0x00,0x00,0xE0,0xFB,0x01,0x00,0xE0,0xE1,0x07},
// {0x00,0xE0,0xC0,0x07,0x00,0x60,0x00,0x07,0x00,0x20,0x00,0x04,0x00,0x00,0x00,0x00},/*"k",10*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0xFF,0x07},
// {0xC0,0xFF,0xFF,0x07,0xC0,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"l",11*/
// {0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07},
// {0x00,0xC0,0x01,0x00,0x00,0xE0,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0xC0,0xFF,0x07,0x00,0xC0,0x01,0x00,0x00,0xE0,0x00,0x00},
// {0x00,0xE0,0x00,0x00,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0xC0,0xFF,0x07},/*"m",12*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0x80,0x07,0x00,0x00,0xC0,0x01,0x00,0x00,0xE0,0x00,0x00},
// {0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x07,0x00,0x00,0x00,0x00},/*"n",13*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFF,0x01,0x00,0x80,0xFF,0x03},
// {0x00,0xC0,0xFF,0x07,0x00,0xC0,0x81,0x07,0x00,0xE0,0x00,0x07,0x00,0xE0,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x01,0x07,0x00,0xC0,0x83,0x07},
// {0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x03,0x00,0x00,0xFF,0x01,0x00,0x00,0x38,0x00},/*"o",14*/
// {0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0x00,0xE0,0xFF,0xFF,0x00,0xE0,0xFF,0xFF},
// {0x00,0xE0,0xFF,0xFF,0x00,0xC0,0x83,0x07,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x01,0x0F,0x00,0xC0,0xFF,0x07},
// {0x00,0xC0,0xFF,0x07,0x00,0x80,0xFF,0x03,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00},/*"p",15*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x80,0xFF,0x01,0x00,0xC0,0xFF,0x03},
// {0x00,0xC0,0xFF,0x07,0x00,0xE0,0x01,0x0F,0x00,0xE0,0x00,0x0E,0x00,0xE0,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0xE0,0x00,0x0E,0x00,0xC0,0x01,0x07,0x00,0xE0,0xFF,0xFF},
// {0x00,0xE0,0xFF,0xFF,0x00,0xE0,0xFF,0xFF,0x00,0xE0,0xFF,0xFF,0x00,0x00,0x00,0x00},/*"q",16*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0x80,0x07,0x00},
// {0x00,0xC0,0x01,0x00,0x00,0xC0,0x01,0x00,0x00,0xE0,0x00,0x00,0x00,0xE0,0x00,0x00},
// {0x00,0xE0,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"r",17*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x83,0x01,0x00,0x80,0x8F,0x03},
// {0x00,0xC0,0x9F,0x07,0x00,0xE0,0x9F,0x07,0x00,0xE0,0x1C,0x0E,0x00,0x60,0x18,0x0E},
// {0x00,0x60,0x18,0x0E,0x00,0x60,0x38,0x0E,0x00,0xE0,0x38,0x0E,0x00,0xE0,0xF1,0x07},
// {0x00,0xC0,0xF1,0x07,0x00,0x80,0xE1,0x03,0x00,0x00,0xC0,0x01,0x00,0x00,0x00,0x00},/*"s",18*/
// {0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x60,0x00,0x00},
// {0x00,0x60,0x00,0x00,0x00,0xFF,0xFF,0x01,0x00,0xFF,0xFF,0x03,0x00,0xFF,0xFF,0x07},
// {0x00,0xFF,0xFF,0x07,0x00,0x60,0x00,0x0E,0x00,0x60,0x00,0x0E,0x00,0x60,0x00,0x0E},
// {0x00,0x60,0x00,0x0E,0x00,0x60,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00},/*"t",19*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0x03,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x0C},
// {0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x06,0x00,0x00,0x80,0x07,0x00,0xE0,0xFF,0x07},
// {0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0xE0,0xFF,0x07,0x00,0x00,0x00,0x00},/*"u",20*/
// {0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0xE0,0x01,0x00,0x00,0xE0,0x0F,0x00},
// {0x00,0xE0,0x7F,0x00,0x00,0x80,0xFF,0x01,0x00,0x00,0xFC,0x0F,0x00,0x00,0xE0,0x0F},
// {0x00,0x00,0xC0,0x0F,0x00,0x00,0xF0,0x0F,0x00,0x00,0xFE,0x07,0x00,0xC0,0xFF,0x00},
// {0x00,0xE0,0x1F,0x00,0x00,0xE0,0x03,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00},/*"v",21*/
// {0x00,0x60,0x00,0x00,0x00,0xE0,0x0F,0x00,0x00,0xE0,0xFF,0x00,0x00,0xE0,0xFF,0x0F},
// {0x00,0x00,0xFC,0x0F,0x00,0x00,0xFC,0x0F,0x00,0xE0,0xFF,0x0F,0x00,0xE0,0x7F,0x00},
// {0x00,0xE0,0x0F,0x00,0x00,0xE0,0xFF,0x03,0x00,0x80,0xFF,0x0F,0x00,0x00,0xE0,0x0F},
// {0x00,0x80,0xFF,0x0F,0x00,0xE0,0xFF,0x03,0x00,0xE0,0x3F,0x00,0x00,0xE0,0x01,0x00},/*"w",22*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x06,0x00,0xE0,0x00,0x07},
// {0x00,0xE0,0x83,0x07,0x00,0xE0,0xE7,0x07,0x00,0x80,0xFF,0x01,0x00,0x00,0xFE,0x00},
// {0x00,0x00,0x7E,0x00,0x00,0x00,0xFF,0x01,0x00,0xC0,0xEF,0x03,0x00,0xE0,0xC3,0x07},
// {0x00,0xE0,0x81,0x07,0x00,0xE0,0x00,0x06,0x00,0x20,0x00,0x04,0x00,0x00,0x00,0x00},/*"x",23*/
// {0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0xE0,0x01,0xE0,0x00,0xE0,0x0F,0xE0},
// {0x00,0xE0,0x7F,0xE0,0x00,0x80,0xFF,0xE1,0x00,0x00,0xFC,0xFF,0x00,0x00,0xE0,0xFF},
// {0x00,0x00,0x80,0x7F,0x00,0x00,0xF0,0x1F,0x00,0x00,0xFE,0x07,0x00,0xC0,0xFF,0x00},
// {0x00,0xE0,0x1F,0x00,0x00,0xE0,0x07,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00},/*"y",24*/
// {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x07,0x00,0x60,0x80,0x07},
// {0x00,0x60,0xC0,0x07,0x00,0x60,0xE0,0x07,0x00,0x60,0xF0,0x06,0x00,0x60,0x78,0x06},
// {0x00,0x60,0x3E,0x06,0x00,0x60,0x1F,0x06,0x00,0xE0,0x0F,0x06,0x00,0xE0,0x07,0x06},
// {0x00,0xE0,0x01,0x06,0x00,0xE0,0x00,0x06,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00},/*"z",25*/
};



void lcd_draw_char(uint16_t x, uint16_t y, uint8_t ch, uint16_t color, uint8_t size)
{
    uint8_t i, j, k;
    switch (ch)
    {
    case 'A':ch=0;break;
    case 'B':ch=1;break;
    case 'D':ch=2;break;
    case 'E':ch=3;break;
    case 'G':ch=4;break;
    case 'I':ch=5;break;
    case 'K':ch=6;break;
    case 'M':ch=7;break;
    case 'N':ch=8;break;
    case 'O':ch=9;break;
    case 'P':ch=10;break;
    case 'Q':ch=11;break;
    case 'R':ch=12;break;
    case 'S':ch=13;break;
    case 'T':ch=14;break;
    case 'U':ch=15;break;
    case 'V':ch=16;break;
    default:return;break;
    }
    uint8_t *p = (uint8_t*)&font[ch*4+3][15];
    for (i=0;i<16; i++)
    {
        for (j=0;j<4;j++)
        {
            for(k=0;k<8;k++){
               if ((*p&(0x80>>k))!=0)
                {
                    lcd_draw_rect(x+(16-i)*size,y+(j*8+k)*size,size,size,color);
                } 
            }
            p--;
        }
    }
}

void lcd_draw_string(uint16_t x, uint16_t y, uint8_t *str, uint16_t color, uint8_t size)
{
    while (*str != '\0')
    {
        lcd_draw_char(x, y,*str,color,size);
        str++;
        x += 16*size;
    }
}

#pragma endregion

#pragma region WS2812
void led_send_0(){
    GPIO_HIGH(2);
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    GPIO_LOW(2);
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
}
void led_send_1(){
    GPIO_HIGH(2);
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    GPIO_LOW(2);
    __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
    // __asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");__asm__("nop");
}
void led_send_data(uint8_t data){
    for(int i=0;i<8;i++){
        if(data&0x80){
            led_send_1();
        }
        else{
            led_send_0();
        }
        data<<=1;
    }
}
void led_send_rgb(uint8_t r, uint8_t g, uint8_t b){
    led_send_data(g);
    led_send_data(r);
    led_send_data(b);
    busy_wait(3);
}
void led_init(){
    led_send_rgb(128,0,0);
    led_send_rgb(128,128,0);
    led_send_rgb(0,128,0);
    led_send_rgb(0,128,128);
    led_send_rgb(0,0,128);
    
    led_send_rgb(128,0,128);
    led_send_rgb(128,128,128);
    led_send_rgb(128,0,0);
    led_send_rgb(128,128,0);
    led_send_rgb(0,128,0);

    led_send_rgb(0,128,128);
    led_send_rgb(0,0,128);
    led_send_rgb(128,0,128);
    led_send_rgb(128,128,128);
}
#pragma endregion

#pragma region UI

void ui_draw_gameover(){
    lcd_draw_string(LCD_HEIGHT/2-144, LCD_WIDTH/2+0,"GAME OVER",COLOR_BLACK,2);
    lcd_draw_string(LCD_HEIGHT/2-140, LCD_WIDTH/2+4,"GAME OVER",COLOR_WHITE,2);
    for(int i=0;i<500;i++){
        BUZZ_DOWN();
        DELAY_MS(2);
        BUZZ_UP();
        DELAY_MS(2);
    }
}

void ui_draw_icon(uint8_t id, uint8_t pos){
    pos=pos%3;
    id=id%3;
    if(id==0){
        lcd_draw_rect(LCD_HEIGHT/2-40-90+pos*90, LCD_WIDTH/2-40, 80, 80, COLOR_GREEN);
        lcd_draw_char(LCD_HEIGHT/2-16-90+pos*90, LCD_WIDTH/2-20, 'G', COLOR_RED,2);
        //lcd_draw_string(LCD_HEIGHT/2-41-90+pos*90, LCD_WIDTH/2-40, "SNAKE", COLOR_RED,1);
    }
    else if(id==1){
        lcd_draw_rect(LCD_HEIGHT/2-40-90+pos*90, LCD_WIDTH/2-40, 80, 80, COLOR_PUPPLE);
        lcd_draw_char(LCD_HEIGHT/2-16-90+pos*90, LCD_WIDTH/2-20, 'T', COLOR_GREEN,2);
        //lcd_draw_string(LCD_HEIGHT/2-41-90+pos*90, LCD_WIDTH/2-40, "ITRIS", COLOR_RED,1);
    }
    else if(id==2){
        lcd_draw_rect(LCD_HEIGHT/2-40-90+pos*90, LCD_WIDTH/2-40, 80, 80, COLOR_BLUE);
        lcd_draw_char(LCD_HEIGHT/2-16-90+pos*90, LCD_WIDTH/2-20, 'B', COLOR_YELLOW,2);
        //lcd_draw_string(LCD_HEIGHT/2-41-90+pos*90, LCD_WIDTH/2-40, "BIRD", COLOR_RED,1);
    }
}
void ui_draw_item(uint16_t x, uint16_t y, uint8_t id){
    if(id==0){//apple
        lcd_draw_rect(x, y, LCD_HEIGHT/SNAKE_MAP_WIDTH, LCD_WIDTH/SNAKE_MAP_HEIGHT, COLOR_RED);
        lcd_draw_rect(x+13, y+13, 5, 5, COLOR_WHITE);
    }
    if(id==1){//snake
        lcd_draw_rect(x, y, LCD_HEIGHT/SNAKE_MAP_WIDTH, LCD_WIDTH/SNAKE_MAP_HEIGHT, COLOR_RED);
        lcd_draw_rect(x+3, y+5, 3, 3, COLOR_ORANGE);
        lcd_draw_rect(x+13, y+11, 2, 3, COLOR_ORANGE);
    }
    if(id==2){//grass
        lcd_draw_rect(x, y, LCD_HEIGHT/SNAKE_MAP_WIDTH, LCD_WIDTH/SNAKE_MAP_HEIGHT, COLOR_GRASS);
    }
}

void ui_draw_scene(uint8_t id){
    if(id==0){
        led_init();
        lcd_clear(COLOR_RED);

        lcd_draw_string(LCD_HEIGHT/2-60, LCD_WIDTH/2+46,"MENU",COLOR_BLACK,2);
        lcd_draw_string(LCD_HEIGHT/2-64, LCD_WIDTH/2+50,"MENU",COLOR_WHITE,2);
        lcd_draw_rect(LCD_HEIGHT/2-40+4, LCD_WIDTH/2-44, 80, 80, COLOR_BLACK);//place icon
        lcd_draw_string(LCD_HEIGHT/2-60, LCD_WIDTH/2-100, "PRESS UP to play", COLOR_WHITE,1);

        ui_draw_icon(0,1);
        ui_draw_icon(1,2);
        ui_draw_icon(2,3);
    }
    else if(id==1){
        lcd_clear(COLOR_GRASS);
    }
    else if(id==2){
        lcd_clear(COLOR_YELLOW);
    }
    else if(id==3){
        lcd_clear(COLOR_BLUE);
    }
}
#pragma endregion

int main()
{
    uart_init();
    //xprintf("UART done!\r\n");
    gpio_init();
    //xprintf("GPIO done!\r\n");
    lcd_init();
    //xprintf("LCD done!\r\n");
    led_init();

    ui_draw_scene(0);
    // state 0: menu
    // state 1: GreedySnake
    // state 2: Tetris
    uint8_t state = 0;
    int8_t menu_choice = 0;
    uint8_t frame_time = 0;
#pragma region GreedySnake
    uint8_t snake_time=0;
    int8_t snake_map[SNAKE_MAP_HEIGHT][SNAKE_MAP_WIDTH] = {0};
    int8_t snake_head_x = SNAKE_MAP_WIDTH/2-1;
    int8_t snake_head_y = SNAKE_MAP_HEIGHT/2-1;
    uint8_t apple_x = snake_head_x+1;
    uint8_t apple_y = snake_head_y+2;
    uint8_t snake_length = 3;
    uint8_t snake_direction = 4;//COMMAND_D
    snake_map[snake_head_y][snake_head_x-2]=3;
    snake_map[snake_head_y][snake_head_x-1]=2;
    snake_map[snake_head_y][snake_head_x]=1;
    snake_map[apple_y][apple_x]=-1;
#pragma endregion
    
#pragma region Tetris
    uint8_t tetris_time=0;
    uint8_t tetris_map[TETRIS_MAP_HEIGHT][TETRIS_MAP_WIDTH] = {0};
    uint8_t tx[4]={7,6,7,8};
    uint8_t ty[4]={11,10,10,10};
    uint8_t movable=0x07;//0111

#pragma endregion
    
    uint8_t key_press = 0;
    uint8_t music=0;
    
    while(1){
#pragma region Start in Frame
        busy_wait(20000);// 20 ms
        frame_time++;
        uint8_t data = uart_getc_nowait();
        if(key_press>0){
            key_press--;
        }
        else if(data==0){
            if(GPIO_STATE(4)==0){
                DELAY_MS(10);
                if(GPIO_STATE(4)==0)
                data = COMMAND_A;
            }
            else if(GPIO_STATE(5)==0){
                DELAY_MS(10);
                if(GPIO_STATE(5)==0)
                data = COMMAND_W;
            }
            else if(GPIO_STATE(6)==0){
                DELAY_MS(10);
                if(GPIO_STATE(6)==0)
                data = COMMAND_S;
            }
            else if(GPIO_STATE(7)==0){
                DELAY_MS(10);
                if(GPIO_STATE(7)==0)
                data = COMMAND_D;
            }
            else if(GPIO_STATE(3)==0){
                DELAY_MS(10);
                if(GPIO_STATE(3)==0)
                data = COMMAND_Q;
            }
            
            key_press=3;
        }
#pragma endregion
        
        if(data != 0){
            xprintf("%c", data);

            if(state==0){
                if(data == COMMAND_A || data == COMMAND_D){
                    if(data == COMMAND_A){
                        if(menu_choice==GAME_COUNT-1) menu_choice=0;
                        else menu_choice++;
                    }
                    else if(data == COMMAND_D){
                        if(menu_choice==0) menu_choice=GAME_COUNT-1;
                        else menu_choice--;
                    }
                    ui_draw_icon(menu_choice,1);
                    ui_draw_icon(menu_choice+1,2);
                    ui_draw_icon(menu_choice+2,3);
                }

                else if(data == COMMAND_W){
                    state = menu_choice+1;
                    
                    if(menu_choice==0){
                        for(int i=0;i<20;i++){
                            led_send_rgb(0,0,0);
                        }
                        snake_time=0;
                        snake_head_x = SNAKE_MAP_WIDTH/2-1;
                        snake_head_y = SNAKE_MAP_HEIGHT/2-1;
                        apple_x = snake_head_x+1;
                        apple_y = snake_head_y+2;
                        snake_length = 3;
                        snake_direction = 4;//COMMAND_D
                        snake_map[snake_head_y][snake_head_x-2]=3;
                        snake_map[snake_head_y][snake_head_x-1]=2;
                        snake_map[snake_head_y][snake_head_x]=1;
                        snake_map[apple_y][apple_x]=-1;
                        
                        ui_draw_scene(1);
                        continue;
                    }
                    else if(menu_choice==1){
                        for(int i=0;i<14;i++){
                            led_send_rgb(0,0,0);
                        }
                        for(int i=0;i<TETRIS_MAP_HEIGHT;i++){
                            for(int j=0;j<TETRIS_MAP_WIDTH;j++){
                                tetris_map[i][j]=0;
                            }
                        }
                        tetris_time=0;
                        uint8_t movable=0x07;//0111
                        ui_draw_scene(2);
                        continue;
                    }
                    else if(menu_choice==2){
                        ui_draw_scene(3);
                        continue;
                    }
                }
            }

            //GreedySnake
            if(state==1){
                if(data == COMMAND_A){
                    if(snake_direction!=4)
                        snake_direction=1;
                }
                else if(data == COMMAND_W){
                    if(snake_direction!=3)
                        snake_direction=2;
                }
                else if(data == COMMAND_S){
                    if(snake_direction!=2)
                        snake_direction=3;
                }
                else if(data == COMMAND_D){
                    if(snake_direction!=1)
                        snake_direction=4;
                }
                else if(data == COMMAND_Q){
                    state=0;
                    ui_draw_scene(0);
                    continue;
                }
            }

            //Tetris
            if(state==2){
                if(data == COMMAND_A && movable&(0x01<<2)){
                    for(int i=0;i<4;i++){
                        tx[i]--;
                    }
                }
                else if(data == COMMAND_D && movable&(0x01)){
                    for(int i=0;i<4;i++){
                        tx[i]++;
                    }
                }
                else if(data == COMMAND_W){
                    uint8_t tx_temp[4];
                    uint8_t ty_temp[4];
                    for(int i=0;i<4;i++){
                        tx_temp[i]=tx[i]-tx[2];
                        ty_temp[i]=ty[i]-ty[2];
                    }
                    for(int i=0;i<4;i++){
                        tx[i]=tx_temp[i]*0-ty_temp[i]*1+tx[2];
                        ty[i]=tx_temp[i]*1+ty_temp[i]*0+ty[2];
                    }
                }
                else if(data == COMMAND_S && movable&(0x01<<1)){
                    while(movable&(0x01<<1)){
                        for(int i=0;i<4;i++){
                            ty[i]--;
                        }
                        for(int i=0;i<4;i++){
                            if(ty[i]==0){
                                movable&=~(0x01<<1);
                                break;
                            }
                            if(tetris_map[ty[i]-1][tx[i]]==1){
                                movable&=~(0x01<<1);
                                break;
                            }
                        }
                    }
                }
                else if(data == COMMAND_Q){
                    state=0;
                    ui_draw_scene(0);

                    continue;
                }
            }
        
            if(state==3){
                if(data == COMMAND_A){
                    
                }
                else if(data == COMMAND_W){
                    
                }
                else if(data == COMMAND_S){
                    
                }
                else if(data == COMMAND_D){
                    
                }
                else if(data == COMMAND_Q){
                    state=0;
                    ui_draw_scene(0);

                    continue;
                }
            }
        }
        else {
            if(state==0){
                music++;
                if(music==100){
                    music=0;
                }
                if(music/25==0){
                    for(int i=0;i<5;i++){
                    PLAY(500);
                    }
                }
                else if(music/25==1){
                    for(int i=0;i<5;i++){
                    PLAY(300);
                    }
                }
                else if(music/25==2){
                    for(int i=0;i<5;i++){
                    PLAY(500);
                    }
                }
                else if(music/25==3){
                    for(int i=0;i<5;i++){
                    PLAY(800);
                    }
                }
            }

            else if(state==1){
                if(snake_time<SNAKE_DELAY){
                    snake_time++;
                    continue;
                }
                else{
                    snake_time=0;
                }
                ROCK_DOWN();
                uint8_t snake_tail_x = 0;
                uint8_t snake_tail_y = 0;
                for(int i=0;i<SNAKE_MAP_HEIGHT;i++){
                    for(int j=0;j<SNAKE_MAP_WIDTH;j++){
                        // body
                        if(snake_map[i][j]>0){
                            snake_map[i][j]++;
                            if(snake_map[i][j]>snake_length){
                                snake_map[i][j]=0;
                                snake_tail_x = j;
                                snake_tail_y = i;

                            }
                        }
                    }
                }
                if(snake_direction==1){
                    snake_head_x--;
                    if(snake_head_x<0){
                        snake_head_x=SNAKE_MAP_WIDTH-1;
                    }
                }
                else if(snake_direction==2){
                    snake_head_y++;
                    if(snake_head_y>=SNAKE_MAP_HEIGHT){
                        snake_head_y=0;
                    }
                }
                else if(snake_direction==3){
                    snake_head_y--;
                    if(snake_head_y<0){
                        snake_head_y=SNAKE_MAP_HEIGHT-1;
                    }
                }
                else if(snake_direction==4){
                    snake_head_x++;
                    if(snake_head_x>=SNAKE_MAP_WIDTH){
                        snake_head_x=0;
                    }
                }
                if(snake_map[snake_head_y][snake_head_x]>0){
                    
                    ui_draw_gameover();
                    ui_draw_scene(0);
                    state=0;
                    continue;
                }
                else if(snake_map[snake_head_y][snake_head_x]==-1){
                    ROCK_UP();
                    for(int i=0;i<snake_length-2;i++){
                        led_send_rgb(0,128,0);
                    }
                    snake_map[snake_head_y][snake_head_x]=1;
                    snake_length++;
                    // summon apple
                    int random = GAME_RANDOM%(SNAKE_MAP_HEIGHT*SNAKE_MAP_WIDTH-snake_length-1);
                    for(int i=0;i<SNAKE_MAP_HEIGHT;i++){
                        for(int j=0;j<SNAKE_MAP_WIDTH;j++){
                            if(snake_map[i][j]>0){
                                continue;
                            }
                            random--;
                            if(random==0){
                                snake_map[i][j]=-1;
                                apple_x=j;
                                apple_y=i;
                                break;
                            }
                        }
                    }
                    
                }
                snake_map[snake_head_y][snake_head_x]=1;
                ui_draw_item(apple_x*LCD_HEIGHT/SNAKE_MAP_WIDTH, apple_y*LCD_WIDTH/SNAKE_MAP_HEIGHT, 0);
                ui_draw_item(snake_tail_x*LCD_HEIGHT/SNAKE_MAP_WIDTH, snake_tail_y*LCD_WIDTH/SNAKE_MAP_HEIGHT, 2);
                ui_draw_item(snake_head_x*LCD_HEIGHT/SNAKE_MAP_WIDTH, snake_head_y*LCD_WIDTH/SNAKE_MAP_HEIGHT, 1);
            }

            else if(state==2){
                if(tetris_time<TETRIS_DELAY){
                    tetris_time++;
                    continue;
                }
                else tetris_time=0;
                //update movable
                movable=0x07;
                for(int i=0;i<4;i++){
                    if(tx[i]==0){
                        movable&=~(0x01<<2);
                        break;
                    }
                    if(tetris_map[ty[i]][tx[i]-1]==1){//x-1为障碍
                        movable&=~(0x01<<2);
                        break;
                    }
                    if(tx[i]==TETRIS_MAP_WIDTH-1){
                        movable&=~(0x01);
                        break;
                    }
                    if(tetris_map[ty[i]][tx[i]+1]==1){//x-1为障碍
                        movable&=~(0x01);
                        break;
                    }
                }
                for(int i=0;i<4;i++){
                    if(ty[i]==0){
                        movable&=~(0x01<<1);
                        break;
                    }
                    if(tetris_map[ty[i]-1][tx[i]]==1){
                        movable&=~(0x01<<1);
                        break;
                    }
                }
                if(movable&(0x01<<1)){//can drop
                    for(int i=0;i<4;i++){
                        ty[i]--;
                    }
                }
                else{
                    for(int i=0;i<4;i++){
                        tetris_map[ty[i]][tx[i]]=1;
                    }
                    if(GAME_RANDOM%3==0){
                        tx[0]=7;
                        tx[1]=6;
                        tx[2]=7;
                        tx[3]=8;
                        ty[0]=11;
                        ty[1]=10;
                        ty[2]=10;
                        ty[3]=10;
                    }
                    else if(GAME_RANDOM%3==1){
                        tx[0]=6;
                        tx[1]=6;
                        tx[2]=7;
                        tx[3]=8;
                        ty[0]=11;
                        ty[1]=10;
                        ty[2]=10;
                        ty[3]=10;
                    }
                    else if(GAME_RANDOM%3==2){
                        tx[0]=6;
                        tx[1]=7;
                        tx[2]=6;
                        tx[3]=7;
                        ty[0]=11;
                        ty[1]=11;
                        ty[2]=10;
                        ty[3]=10;
                    }
                    for(int i=0;i<TETRIS_MAP_HEIGHT;i++){//check a line
                        for(int j=0;j<TETRIS_MAP_WIDTH;j++){
                            if(tetris_map[i][j]!=1){
                                break;
                            }
                            if(j==TETRIS_MAP_WIDTH-1){
                                for(int k=i;k<TETRIS_MAP_HEIGHT;k++){
                                    for(int l=0;l<TETRIS_MAP_WIDTH;l++){
                                        if(k==TETRIS_MAP_HEIGHT-1){
                                            tetris_map[k][l]=0;
                                            continue;
                                        }
                                        else tetris_map[k][l]=tetris_map[k+1][l];
                                    }
                                }
                            }
                        }
                    }
                }
                
                //draw
                for(int i=0;i<TETRIS_MAP_HEIGHT;i++){
                    for(int j=0;j<TETRIS_MAP_WIDTH;j++){
                        if(tetris_map[i][j]==0){
                            lcd_draw_rect(j*LCD_HEIGHT/TETRIS_MAP_WIDTH, i*LCD_WIDTH/TETRIS_MAP_HEIGHT, LCD_HEIGHT/TETRIS_MAP_WIDTH, LCD_WIDTH/TETRIS_MAP_HEIGHT, COLOR_WHITE);
                            for(int k=0;k<4;k++)
                                if(i==ty[k]&&j==tx[k])
                                    lcd_draw_rect(j*LCD_HEIGHT/TETRIS_MAP_WIDTH, i*LCD_WIDTH/TETRIS_MAP_HEIGHT, LCD_HEIGHT/TETRIS_MAP_WIDTH, LCD_WIDTH/TETRIS_MAP_HEIGHT, COLOR_GREEN);
                        }
                        else {
                            lcd_draw_rect(j*LCD_HEIGHT/TETRIS_MAP_WIDTH, i*LCD_WIDTH/TETRIS_MAP_HEIGHT, LCD_HEIGHT/TETRIS_MAP_WIDTH, LCD_WIDTH/TETRIS_MAP_HEIGHT, COLOR_RED);
                        }
                    }
                }
            }
        }
    }
}
